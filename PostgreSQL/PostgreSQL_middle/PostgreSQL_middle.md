# PostgreSQL_middle

---

## Вопрос 1
На какой тип данных нельзя применить ограничение уникальности (unique constraint)?

- json  
- timestamp  
- smallint  
- serial  
- jsonb

---

## Вопрос 2
Была создана специальная последовательность, генерирующая только четные числа, с названием even_sequence. Что нужно подставить на место пропуска \[...\], чтобы в случае, если значение even_column не было указано при вставке, значение бралось из even_sequence?

1 CREATE TABLE some_table (  
2   even_column [...]  
3 );

- integer generated by even_sequence  
- integer unique default nextval('even_sequence')  
- integer generated always as identity (start with 2 increment by 2)  
- integer default nextval('even_sequence')  
- integer computed as nextval('even_sequence')

---

## Вопрос 3
У вас есть две связанные таблицы: first_table и second_table. Вы хотите выполнить команду TRUNCATE TABLE second_table CASCADE;, чтобы удалить все строки из таблицы second_table и всех зависимых от нее данных. Какие последствия может иметь выполнение этой команды?

1 CREATE TABLE first_table (  
2   id INTEGER PRIMARY KEY  
3 );  
4  
5 CREATE TABLE second_table (  
6   id SERIAL PRIMARY KEY,  
7   first_table_fk INTEGER REFERENCES first_table(id)  
8 );

- При последующей вставке в second_table дефолтное значение для id может начинаться с некорректного значения.  
- Существующие индексы для second_table будут удалены и автоматически пересозданы.  
- Последовательность second_table_id_seq будет сброшена до начального значения.  
- Возникнет ошибка, так как команда CASCADE запрещена для таблиц с внешними ключами.  
- Удалятся все записи из first_table, связанные через внешний ключ с second_table.

---

## Вопрос 4
Была создана таблица, в которую добавили записи. Добавление записей в таблицу происходило из нескольких мест, и в каждом случае нужно было учитывать следующую логику: price > 0 && price > discount && discount > 0. Поскольку вставка происходила из нескольких мест, было решено перенести эти ограничения на уровень базы данных, чтобы случайно не вставить некорректные данные. Был выполнен запрос, указанный ниже.

С какими проблемами можно столкнуться?

1 -- таблица  
2 CREATE TABLE prices_list (  
3   id SERIAL PRIMARY KEY,  
4   product_id INT NOT NULL,  
5   price NUMERIC NOT NULL,  
6   discount NUMERIC,  
7   valid_from DATE NOT NULL,  
8   valid_to DATE NOT NULL  
9 );  
10 -- запрос  
11 ALTER TABLE prices_list  
12 ADD CONSTRAINT price_discount_check  
13 CHECK (  
14   price > 0  
15   AND discount > 0  
16   AND price > discount  
17 );

- Проблемы возникнут, если discount имеет значение NULL, так как NULL в логических операциях делает условие неопределённым.  
- Ограничение будет применено только к новым записям, что может потребовать дополнительной валидации для существующих данных.  
- Названию ограничения (constraint) нужно явно указать связанные колонки, иначе оно не будет применено.  
- Логические операторы в условии нужно заключить в дополнительные скобки, иначе приоритет их выполнения нарушится.  
- Ограничение невозможно применить из-за отсутствия индексированного столбца в условии.

---

## Вопрос 5
Создана структура таблиц, указанная на изображении. Необходимо выполнить запрос, указанный на изображении. Какой вид join необходимо использовать на месте пропуска \[...\], чтобы в результате для записей с type = 'table_aw' была заполнена колонка naming, а для записей с type = 'table2' — колонка serial_number?

1 CREATE TABLE multirelation (  
2   type VARCHAR NOT NULL,  
3   entity_id INTEGER NOT NULL  
4 );  
5  
6 CREATE TABLE table_aw (  
7   id INTEGER PRIMARY KEY,  
8   naming VARCHAR NOT NULL  
9 );  
10  
11 CREATE TABLE table2 (  
12   id INTEGER PRIMARY KEY,  
13   serial_number VARCHAR NOT NULL  
14 );  
-- структура таблиц  
15  
16 SELECT m.type, m.entity_id, ta.naming, t2.serial_number  
17 FROM multirelation m  
18 [...] JOIN table_aw ta ON m.entity_id = ta.id AND m.type = 'table_aw'  
19 [...] JOIN table2 t2 ON m.entity_id = t2.id AND m.type = 'table2';  
-- запрос

- cross  
- left  
- right  
- inner  
- Оставить пустым

---

## Вопрос 6
В базе данных есть таблица departments, где хранится информация о департаментах компании, и таблица employees, где хранятся данные о сотрудниках. На колонку department_id в таблице employees установлен внешний ключ, ссылающийся на id в таблице departments. Для какой из приведённых конструкций будет выдана ошибка при создании таблицы employees?

1 CREATE TABLE departments (  
2   id SERIAL PRIMARY KEY,  
3   name TEXT NOT NULL  
4 );  
5  
6 CREATE TABLE employees (  
7   employee_id SERIAL PRIMARY KEY,  
8   department_id [...],  
9   REFERENCES departments(id)  
10 );

- bigint  
- numeric  
- bigserial  
- serial  
- integer

---

## Вопрос 7
Какое выражение на месте пропуска \[...\] автоматически приведет к созданию индекса?

1 CREATE TABLE some_table (  
2   col_name [...]  
3 );

- references other_table(col_name)  
- not null  
- serial  
- unique  
- integer check (col_name > 0)

---

## Вопрос 8
У вас есть таблица orders, в которой выполняются частые запросы на фильтрацию по колонке customer_id и сортировку по order_date. Какой индекс необходимо создать, чтобы одновременно ускорить фильтрацию и сортировку?

1 CREATE TABLE orders (  
2   order_id SERIAL PRIMARY KEY,  
3   customer_id INTEGER NOT NULL,  
4   order_date DATE NOT NULL  
5 );

- Нет необходимости создавать индекс, достаточно использовать PRIMARY KEY для order_id.  
- CREATE INDEX <index_name> ON orders (order_date) USING HASH;  
- CREATE INDEX <index_name> ON orders (order_date, customer_id);  
- CREATE UNIQUE INDEX <index_name> ON orders (order_date, customer_id);  
- CREATE INDEX <index_name> ON orders (customer_id, order_date);

---

## Вопрос 9
В PostgreSQL заголовок версии строки включает параметр xmax. Какова его роль в управлении транзакциями?

- Для блокировки строки от одновременных изменений несколькими транзакциями  
- Для обозначения номера транзакции, которая удалила или обновила строку  
- Для создания уникального идентификатора строки в таблице  
- Для проверки видимости строки другими транзакциями  
- Для указания максимального значения, которое может быть записано в числовую колонку

---

## Вопрос 10
В PostgreSQL необходимо оптимизировать производительность транзакций за счет минимального уровня изоляции, при котором:

* параллельные транзакции могут видеть незавершённые изменения друг друга;  
* возможны "грязные чтения" (dirty read).

Какой уровень изоляции нужно указать для транзакции, чтобы достичь этой цели?

- read uncommitted  
- read committed  
- dirty read невозможен в PostgreSQL  
- serializable  
- repeatable read

---

## Вопрос 11
Существуют две транзакции. Сначала первая транзакция выполняет команду. Затем вторая транзакция выполняет команду. Далее первая транзакция продолжает выполняться.

Какая последовательность приведет к взаимоблокировке?

1 -- первая транзакция  
2 UPDATE accounts SET balance = balance + 100 WHERE id = ?;  
3 -- вторая транзакция  
4 UPDATE accounts SET balance = balance + 50 WHERE id = ?;  
5 UPDATE accounts SET balance = balance + 200 WHERE id = ?;

- 1112  
- 2112  
- 2211  
- 1212  
- 1122

---

## Вопрос 12
Создана следующая таблица. Вам нужно вставить новую запись через представление. Какой оператор нужно добавить на место пропуска \[...\], чтобы гарантировать, что добавляемая запись соответствует условиям представления?

1 CREATE TABLE films (  
2   id INT PRIMARY KEY,  
3   name VARCHAR NOT NULL,  
4   kind VARCHAR NOT NULL,  
5   duration INT  
6 );  
7  
8 CREATE VIEW comedies AS  
9 SELECT id, name  
10 FROM films  
11 WHERE kind = 'Comedy' [...];  
12 -- команда  
13 INSERT INTO comedies(id, name) VALUES (7, 'New Comedy Film');

- except  
- with check option  
- limit  
- union  
- distinct